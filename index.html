<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Generator</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- Mermaid for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#6366f1',
                primaryTextColor: '#fff',
                primaryBorderColor: '#8b5cf6',
                lineColor: '#a0a0b8',
                secondaryColor: '#8b5cf6',
                tertiaryColor: '#1a1a2e',
                background: '#1a1a2e',
                mainBkg: '#252542',
                textColor: '#ffffff'
            }
        });
        window.mermaid = mermaid;
    </script>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </div>
                <h1>Schema Generator</h1>
            </div>
            <p class="subtitle">Generador de JSON Schemas para entidades</p>

            <!-- User Info (shown when logged in) -->
            <div class="user-section" id="userSection" style="display: none;">
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn btn-secondary btn-sm" id="logoutBtn">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </header>

        <!-- Auth Section (shown when not logged in) -->
        <section class="auth-section" id="authSection">
            <div class="auth-card">
                <h2>üîê Iniciar Sesi√≥n</h2>
                <p>Inicia sesi√≥n para colaborar en proyectos</p>

                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="tu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contrase√±a</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Iniciar Sesi√≥n</button>
                </form>

                <div class="auth-error" id="authError" style="display: none;"></div>
            </div>
        </section>

        <!-- Main Content (shown when logged in) -->
        <main class="main-content" id="mainContent" style="display: none;">

            <!-- Project Selector -->
            <section class="panel project-panel">
                <div class="panel-header">
                    <h2>
                        <span class="icon">üìÅ</span>
                        Proyecto
                    </h2>
                    <div class="header-actions">
                        <select id="projectSelect" class="project-select">
                            <option value="">-- Seleccionar Proyecto --</option>
                        </select>
                        <button class="btn btn-primary" id="newProjectBtn">
                            <span>‚ûï</span> Nuevo Proyecto
                        </button>
                    </div>
                </div>
                <div class="panel-body project-info" id="projectInfo" style="display: none;">
                    <div class="project-details">
                        <span id="projectName"></span>
                        <div class="project-actions">
                            <button class="btn btn-secondary btn-sm" id="inviteMemberBtn">
                                <span>üë•</span> Invitar Miembro
                            </button>
                            <button class="btn btn-secondary btn-sm" id="editProjectBtn">
                                <span>‚úèÔ∏è</span> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" id="deleteProjectBtn">
                                <span>üóëÔ∏è</span> Eliminar
                            </button>
                        </div>
                    </div>
                    <div class="project-members-list" id="projectMembersList"></div>
                    <div class="sync-status" id="syncStatus">
                        <span class="sync-indicator synced"></span>
                        <span>Sincronizado</span>
                    </div>
                </div>
            </section>

            <!-- Saved Schemas Panel -->
            <section class="panel saved-schemas-panel" id="schemasSection" style="display: none;">
                <div class="panel-header">
                    <h2>
                        <span class="icon">üíæ</span>
                        Schemas
                        <span class="schema-count" id="schemaCount">(0)</span>
                    </h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="schemaSearch" placeholder="üîç Buscar..." class="search-input">
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" id="gridViewBtn" title="Vista Grid">‚ñ¶</button>
                            <button class="view-btn" id="listViewBtn" title="Vista Lista">‚ò∞</button>
                        </div>
                        <button class="btn btn-primary btn-sm" id="saveSchemaBtn" title="Guardar Schema">
                            <span>üíæ</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="newSchemaBtn" title="Nuevo Schema">
                            <span>‚ûï</span>
                        </button>
                        <button class="btn btn-accent btn-sm" id="viewDiagramBtn" title="Ver Diagrama de Relaciones">
                            <span>üî∑</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="exportProjectBtn" title="Exportar todos">
                            <span>üì§</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="importProjectBtn" title="Importar">
                            <span>üì•</span>
                        </button>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;">
                    </div>
                </div>
                <div class="panel-body schemas-panel-body">
                    <div id="savedSchemasList" class="saved-schemas-grid">
                        <div class="empty-state" id="savedEmptyState">
                            <p>No hay schemas en este proyecto</p>
                            <small>Crea un schema para empezar</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Collections Section - Improved -->
            <section class="panel collections-panel" id="collectionsSection" style="display: none;">
                <div class="panel-header">
                    <h2>
                        <span class="icon">üìö</span>
                        Collections
                    </h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-sm" id="copyCollectionsBtn" title="Copiar JSON">
                            <span>{ }</span> JSON
                        </button>
                        <button class="btn btn-secondary btn-sm" id="copyCollectionsArrayBtn" title="Copiar como array">
                            <span>[ ]</span> Array
                        </button>
                    </div>
                </div>
                <div class="panel-body collections-body">
                    <div id="collectionsChips" class="collections-chips"></div>
                </div>
            </section>

            <!-- Two Column Layout -->
            <div class="two-column-layout">
                <!-- Left Column -->
                <div class="column-left">

                    <!-- Entity Configuration Panel -->
                    <section class="panel entity-panel" id="entitySection" style="display: none;">
                        <div class="panel-header">
                            <h2>
                                <span class="icon">‚öôÔ∏è</span>
                                Configuraci√≥n de Entidad
                            </h2>
                        </div>
                        <div class="panel-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="entityName">Nombre de Entidad *</label>
                                    <input type="text" id="entityName" placeholder="ej: cat_tipo_personas" required>
                                </div>
                                <div class="form-group">
                                    <label for="version">Versi√≥n</label>
                                    <input type="number" id="version" value="1" min="1">
                                </div>
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="mutable" checked>
                                        <span class="checkmark"></span>
                                        Mutable
                                    </label>
                                </div>
                            </div>

                            <!-- Inheritance Section -->
                            <div class="inheritance-section">
                                <h3>Herencia</h3>
                                <div class="form-grid">
                                    <div class="form-group checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="isBase" checked>
                                            <span class="checkmark"></span>
                                            Es Base
                                        </label>
                                    </div>
                                    <div class="form-group extends-fields">
                                        <label for="extendsSelect">Extiende de</label>
                                        <select id="extendsSelect">
                                            <option value="">-- Seleccionar entidad --</option>
                                        </select>
                                    </div>
                                    <div class="form-group extends-fields">
                                        <label for="strategy">Estrategia</label>
                                        <select id="strategy">
                                            <option value="">-- Seleccionar estrategia --</option>
                                            <option value="override">Override</option>
                                            <option value="merge">Merge</option>
                                            <option value="replace">Replace</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Properties Section -->
                    <section class="panel properties-panel" id="propertiesSection" style="display: none;">
                        <div class="panel-header">
                            <h2>
                                <span class="icon">üìã</span>
                                Propiedades
                            </h2>
                            <button class="btn btn-primary" id="addPropertyBtn">
                                <span>+</span> Agregar Propiedad
                            </button>
                        </div>
                        <div class="panel-body">
                            <div id="propertiesList" class="properties-list">
                                <div class="empty-state" id="emptyState">
                                    <div class="empty-icon">üì≠</div>
                                    <p>No hay propiedades definidas</p>
                                    <small>Haz clic en "Agregar Propiedad" para comenzar</small>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Right Column -->
                <div class="column-right">
                    <!-- Output Section -->
                    <section class="panel output-panel" id="outputSection" style="display: none;">
                        <div class="panel-header">
                            <h2>
                                <span class="icon">üìÑ</span>
                                JSON Generado
                            </h2>
                            <div class="header-actions">
                                <button class="btn btn-secondary" id="copyBtn">
                                    <span>üìã</span> Copiar
                                </button>
                                <button class="btn btn-secondary" id="downloadBtn">
                                    <span>‚¨áÔ∏è</span> Descargar
                                </button>
                                <button class="btn btn-accent" id="generateBtn">
                                    <span>üîÑ</span> Generar
                                </button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <pre id="jsonOutput"
                                class="json-output"><code>{ "message": "Configure la entidad y agregue propiedades para generar el schema" }</code></pre>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <!-- Property Modal -->
        <div class="modal-overlay" id="propertyModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="modalTitle">Agregar Propiedad</h3>
                    <button class="close-btn" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="propertyForm">
                        <input type="hidden" id="editIndex" value="-1">

                        <div class="form-section">
                            <h4>Informaci√≥n B√°sica</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="propKey">Clave (key) *</label>
                                    <input type="text" id="propKey" placeholder="ej: codigo" required>
                                </div>
                                <div class="form-group">
                                    <label for="propName">Nombre *</label>
                                    <input type="text" id="propName" placeholder="ej: C√≥digo" required>
                                </div>
                                <div class="form-group">
                                    <label for="propType">Tipo *</label>
                                    <select id="propType" required>
                                        <option value="id">id</option>
                                        <option value="text">text</option>
                                        <option value="number">number</option>
                                        <option value="decimal">decimal</option>
                                        <option value="bool">bool</option>
                                        <option value="date">date</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="propOrder">Orden</label>
                                    <input type="number" id="propOrder" value="1" min="1">
                                </div>
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="propIsReference">
                                        <span class="checkmark"></span>
                                        Es Referencia (FK)
                                    </label>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="propDescription">Descripci√≥n</label>
                                <textarea id="propDescription" placeholder="Descripci√≥n de la propiedad..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="propGroup">Grupo</label>
                                <input type="text" id="propGroup" placeholder="ej: datos_personales">
                            </div>
                            <div class="form-group">
                                <label for="propMaxLength">Max Length</label>
                                <input type="number" id="propMaxLength" value="0" min="0">
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>Opciones</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propRequired">
                                    <span class="checkmark"></span>
                                    Required
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propHidden">
                                    <span class="checkmark"></span>
                                    Hidden
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propIsPrimaryKey">
                                    <span class="checkmark"></span>
                                    Is Primary Key
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propIsUnique">
                                    <span class="checkmark"></span>
                                    Is Unique
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propIsSerchable">
                                    <span class="checkmark"></span>
                                    Is Searchable
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="propIsSortable">
                                    <span class="checkmark"></span>
                                    Is Sortable
                                </label>
                            </div>
                        </div>

                        <!-- Reference Relation Section -->
                        <div class="form-section relation-section" id="relationSection" style="display: none;">
                            <h4>Relaci√≥n de Referencia (ReferenceRelation)</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="relationKind">Kind *</label>
                                    <select id="relationKind">
                                        <option value="lookup">Lookup</option>
                                        <option value="embed">Embed</option>
                                        <option value="link">Link</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="relationTargetEntity">Target Entity *</label>
                                    <select id="relationTargetEntity">
                                        <option value="">-- Seleccionar entidad --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="relationLocalField">Local Field *</label>
                                    <input type="text" id="relationLocalField" placeholder="ej: cliente_id">
                                </div>
                                <div class="form-group">
                                    <label for="relationTargetField">Target Field *</label>
                                    <select id="relationTargetField">
                                        <option value="">-- Primero selecciona entidad --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="relationCardinality">Cardinality *</label>
                                    <select id="relationCardinality">
                                        <option value="one-to-one">One to One</option>
                                        <option value="one-to-many">One to Many</option>
                                        <option value="many-to-one">Many to One</option>
                                        <option value="many-to-many">Many to Many</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Project Modal (Create/Edit) -->
        <div class="modal-overlay" id="projectModal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h3 id="projectModalTitle">Nuevo Proyecto</h3>
                    <button class="close-btn" id="closeProjectModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="projectForm">
                        <input type="hidden" id="projectId">
                        <div class="form-group">
                            <label for="newProjectName">Nombre del Proyecto *</label>
                            <input type="text" id="newProjectName" placeholder="ej: Mi Proyecto" required>
                        </div>
                        <div class="form-group">
                            <label for="newProjectDesc">Descripci√≥n</label>
                            <textarea id="newProjectDesc" placeholder="Descripci√≥n del proyecto..."></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelProjectBtn">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="submitProjectBtn">Crear Proyecto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Invite Member Modal -->
        <div class="modal-overlay" id="memberModal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h3>Invitar Miembro</h3>
                    <button class="close-btn" id="closeMemberModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <div class="form-group">
                            <label for="memberSelect">Seleccionar Usuario *</label>
                            <select id="memberSelect" required>
                                <option value="">-- Seleccionar usuario --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="memberRole">Rol</label>
                            <select id="memberRole">
                                <option value="editor">Editor (puede crear/editar schemas)</option>
                                <option value="viewer">Viewer (solo lectura)</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelMemberBtn">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Invitar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <span class="toast-icon">‚úì</span>
            <span class="toast-message" id="toastMessage">Operaci√≥n exitosa</span>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Cargando...</p>
        </div>

        <!-- Diagram Viewer Modal -->
        <div class="diagram-modal" id="diagramModal" style="display: none;">
            <div class="diagram-modal-content">
                <div class="diagram-modal-header">
                    <h2>üî∑ Diagrama de Relaciones</h2>
                    <div class="diagram-actions">
                        <button class="btn btn-secondary btn-sm" id="exportMermaidBtn" title="Exportar c√≥digo Mermaid">
                            <span>üíæ</span> C√≥digo
                        </button>
                        <button class="btn btn-secondary btn-sm" id="exportDiagramBtn" title="Exportar como imagen">
                            <span>üì∑</span> SVG
                        </button>
                        <button class="btn btn-secondary btn-sm" id="refreshDiagramBtn" title="Refrescar diagrama">
                            <span>üîÑ</span> Refrescar
                        </button>
                        <button class="close-diagram-btn" id="closeDiagramBtn">‚úï</button>
                    </div>
                </div>
                <div class="diagram-modal-body">
                    <div class="diagram-info">
                        <p>Este diagrama muestra todas las entidades y sus relaciones en el proyecto actual.</p>
                        <div class="diagram-controls">
                            <button class="btn-zoom" id="zoomInBtn" title="Acercar">‚ûï</button>
                            <button class="btn-zoom" id="zoomOutBtn" title="Alejar">‚ûñ</button>
                            <button class="btn-zoom" id="zoomResetBtn" title="Restablecer">‚Ü∫</button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                        </div>
                    </div>
                    <div class="diagram-container" id="diagramContainer">
                        <div class="diagram-loading" id="diagramLoading">
                            <div class="loading-spinner"></div>
                            <p>Generando diagrama...</p>
                        </div>
                        <div class="diagram-content" id="diagramContent"></div>
                        <div class="diagram-empty" id="diagramEmpty" style="display: none;">
                            <p>No hay esquemas con relaciones para mostrar</p>
                            <small>Crea esquemas con propiedades de tipo relaci√≥n para verlos aqu√≠</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options Modal -->
        <div class="modal-overlay" id="exportModal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h3>üì§ Opciones de Exportaci√≥n</h3>
                    <button class="close-btn" id="closeExportModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1rem; color: var(--text-muted);">Selecciona c√≥mo deseas exportar los schemas:</p>
                    <div class="export-options">
                        <button class="btn btn-primary btn-block export-option-btn" id="exportSingleFileBtn">
                            <span>üìÑ</span>
                            <div class="export-option-text">
                                <strong>Archivo √∫nico</strong>
                                <small>Todos los schemas en un solo archivo JSON</small>
                            </div>
                        </button>
                        <button class="btn btn-secondary btn-block export-option-btn" id="exportMultipleFilesBtn">
                            <span>üìÅ</span>
                            <div class="export-option-text">
                                <strong>Archivos individuales (ZIP)</strong>
                                <small>Un archivo JSON por schema, comprimidos en ZIP</small>
                            </div>
                        </button>
                    </div>
                    <div class="modal-footer" style="margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" id="cancelExportBtn">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="supabase-config.js"></script> -->
    <script type="module" src="app.js"></script>
</body>

</html>